name: dual-core-approval
description: Phase 1 only. Plan, audit, and build APPROVAL.md, then always stop for explicit human approval.
interactive_mode: persona
initial_movement: plan
max_movements: 12

piece_config:
  provider_options:
    claude:
      network_access: true
    codex:
      network_access: true

movements:
  - name: plan
    edit: false
    permission_mode: readonly
    provider: claude
    model: claude-opus-4-6[1m]
    persona: architect-planner
    knowledge: architecture
    allowed_tools: [Read, Glob, Grep]
    instruction_template: |
      Goal: create PLAN.md at repository root before any code changes.
      Constraints:
      - Do not modify source code in this movement.
      Deliverables:
      - PLAN.md with requirements, candidate files, implementation steps, validation criteria,
        rollback procedure, and risks.
      - A short movement report summarizing key decisions.
    output_contracts:
      report:
        - name: 01-plan-summary.md
    rules:
      - condition: done
        next: audit

  - name: audit
    edit: false
    permission_mode: readonly
    provider: codex
    model: gpt-5.3-codex
    persona: security-reviewer
    knowledge: architecture
    allowed_tools: [Read, Glob, Grep]
    instruction_template: |
      Input: PLAN.md at repository root.
      Goal: audit the plan for missing items, contradictions, security risks, dependency gaps,
      and execution risks.
      Deliverables:
      - AUDIT.md at repository root with PASS/FAIL and evidence.
      - Report with top 5 critical findings.
      Constraint:
      - Do not modify source code in this movement.
    output_contracts:
      report:
        - name: 02-audit-top5.md
    rules:
      - condition: done
        next: approval

  - name: approval
    edit: true
    permission_mode: edit
    provider: claude
    model: claude-opus-4-6[1m]
    persona: supervisor
    knowledge: architecture
    allowed_tools: [Read, Glob, Grep, Edit]
    instruction_template: |
      Inputs: PLAN.md and AUDIT.md.
      Goal: generate APPROVAL.md at repository root as a pre-implementation approval packet.
      Required sections in APPROVAL.md:
      - Purpose
      - Changed files list (planned)
      - Change summary (3-7 bullets)
      - Impact scope
      - Commands to run and expected results
      - Risk and unresolved items
      - Rollback plan
      - Approval fields: Approved(Y/N), Reason, Timestamp
      Rules:
      - Do not modify source code except APPROVAL.md in this movement.
      - Choose Approved(Y/N) based on PLAN.md and AUDIT.md findings.
      - Always produce APPROVAL.md and finish with status tag "done".
    output_contracts:
      report:
        - name: 03-approval-gate.md
    rules:
      - condition: done
        next: COMPLETE
